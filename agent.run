#!/bin/sh
[ -z "$WSS_URL" ] && WSS_URL="wss://agent.dataloop.io"
echo "Started container agent service" >> /var/log/dataloop/agent.log
containername=$(grep cpu: /proc/self/cgroup | cut -d ':' -f3)
echo "container name is $containername" >> /var/log/dataloop/agent.log
fingerprint=$(echo $containername | /opt/dataloop/embedded/bin/python -c "import sys, uuid; print str(uuid.uuid5(uuid.UUID('12345678123456781234567812345678'), sys.stdin.read().strip()))")
cat <<EOF >> /etc/dataloop/agent.finger
[private]
fingerprint = $fingerprint
EOF
exec /opt/dataloop/embedded/bin/python \
     /opt/dataloop/agent/agent.py -a $API_KEY --server $WSS_URL --name $(cat /rootfs/etc/hostname) \
     >>/var/log/dataloop/agent.log 2>&1
