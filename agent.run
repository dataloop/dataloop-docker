#!/bin/sh
[ -z "$WSS_URL" ] && WSS_URL="wss://agent.dataloop.io"
echo "Started container agent service" >> /var/log/dataloop/agent.log
fingerprint=$(cat /proc/self/cgroup | grep docker | grep -o -E '[0-9a-f]{64}' | head -n 1 | cut -c1-12 | /opt/dataloop/embedded/bin/python -c "import sys, uuid; print str(uuid.uuid5(uuid.UUID('12345678123456781234567812345678'), sys.stdin.read()))";)
cat <<EOF >> /etc/dataloop/agent.finger
[private]
fingerprint = $fingerprint
EOF
exec /opt/dataloop/embedded/bin/python \
     /opt/dataloop/agent/agent.py -a $API_KEY --server $WSS_URL --name $(cat /rootfs/etc/hostname) \
     >>/var/log/dataloop/agent.log 2>&1
